name: update chart versions

on:
  repository_dispatch:
    types: tag-released

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:

    - name: prepare environment
      run: |
        echo "REMOTE_REF=${{ github.event.client_payload.ref }}" >> $GITHUB_ENV
        if [[ ${{ env.REMOTE_REF }} =~ ^(\d+\.)?(\d+\.)?(\*|\d+)$ ]]; then
          echo "using valid tag ${{ env.REMOTE_REF }}"
        else
          echo "could not validate tag format ${{ env.REMOTE_REF }}"
          echo "EARLY_EXIT=true" >> $GITHUB_ENV
        fi

    - name: checkout commit
      if: ${{ env.EARLY_EXIT != true }}
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: update versions
      if: ${{ env.EARLY_EXIT != true }}
      run: |
        sed -i "s/version:.*/version: ${{ env.REMOTE_REF }}/" "charts/inscriptis/Chart.yaml"
        sed -i "s/appVersion:.*/appVersion: ${{ env.REMOTE_REF }}/" "charts/inscriptis/Chart.yaml"
        sed -i "s/  tag:.*/  tag: ${{ env.REMOTE_REF }}/" "charts/inscriptis/values.yaml"

    - name: push version commit
      if: ${{ env.EARLY_EXIT != true }}
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
        git add -A
        git commit -m '[github-actions] bump chart version number.'
        git push